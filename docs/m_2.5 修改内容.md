# =====================================
# docs/M2.5_说明.md
# =====================================
# M2.5｜QMT 行情桥（先补后取 & 订阅前补齐）

## 一、背景与边界
- 真实运行环境下，`xtdata.get_market_data(...)` 仅在 **MiniQMT 本地库已有对应区间数据** 时才返回；
- 历史链路需要从“在线直取”改为“**先补后取**”：`download_history_data` → `get_market_data_in / get_market_data`；
- 实时链路仅负责**订阅推送到 Redis PubSub**，但在订阅启动前应做一次**历史补齐（预热）**；
- 本项目的边界：**只负责数据推送与历史获取 API 封装**，不负责权威库的写入与调度。

## 二、目标
1. 提供**历史获取 API**：封装成“先补后取”的统一接口，输出项目约定的**宽表**；
2. 提供**实时主推**：订阅前对配置标的做**预热补齐**，再按 close-delay 判收盘推送到 Redis PubSub；
3. 兼容多标获取：优先使用 `get_market_data_in(field_list=[], stock_list=[...], ...)`；
4. 明确 `time==0` 的语义（表示该标的该列无实际值），过滤掉无效列。

## 三、主要变更摘要
- 新增：`core/local_cache.py` —— MiniQMT 本地数据**补齐编排器**（按日期 download，增量/重试）；
- 改造：`core/history_api.py` —— 历史接口内部流程改为 **download → get_in → 宽表转换**；
- 改造：`core/realtime_service.py` —— 启动时 **订阅前补齐**（可配置 `preload_days`）；
- 改造：`core/qmt_connector.py` —— 新增 `mode`，默认 `none`，跳过 `xtdatacenter.listen`（规避环境限制）。

## 四、架构与流程
```
调用方/权威库 ←—— HistoryAPI.fetch_bars ——→ LocalCache.ensure_downloaded
                                      │
                                      └─(download_history_data 日期分块)
                                      ↓
                               xtdata.get_market_data_in
                                      ↓
                                宽表转换（过滤 time==0）

RealtimeSubscriptionService.run_forever
  ├─ 订阅前补齐（preload_days）
  ├─ subscribe_quote 回调 → 拉取最近 2 根 → close-delay 判收盘
  └─ 发布至 Redis PubSub（宽表 JSON，幂等去重）
```

## 五、接口影响
- `HistoryAPI.fetch_bars(...)`：签名不变；内部改为“先补后取”；返回 `count/head_ts/tail_ts/gaps` 与可选 `data`（宽表）。
- `RealtimeSubscriptionService`：新增预热配置 `preload_days`；默认 `close_only` 推送。
- `QMTConnector`：`mode='none'|'legacy'`，默认为 `none` 跳过 listen。

## 六、配置建议
- `config/history.yml`
  - `fill_data_on_get: false`
  - `use_batch_get_in: true`
- `config/realtime.yml`
  - `preload_days: 3`
  - `mode: close_only`
- `config/qmt.yml`
  - `connector_mode: none`
  - （可选）`data_dir`：对齐 MiniQMT 数据目录，便于排障与共享。

## 七、失败与重试
- `download_history_data` 失败：按日期分块逐个重试（指数回退）；
- 站点异常（FAQ 2.21）：在运维文档中指导切换站点 IP；
- 获取为空：返回 `count=0`；`gaps` 基于“应有时间序列”计算。

## 八、上线步骤
1. 拉取 M2.5 分支，覆盖/新增文件；
2. 更新配置：`connector_mode=none`、`preload_days` 等；
3. 在 PyCharm 运行 `scripts/qmt_api_probe_min.py` 验证 download→get_in；
4. 运行历史脚本与实时脚本，观察日志输出与 Redis 流；
5. 回滚：恢复至 M2 分支代码与配置。